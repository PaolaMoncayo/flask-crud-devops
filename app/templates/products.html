{% extends "base.html" %}

{% block title %}Productos - Sistema de Inventario{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Productos</h1>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal">
            <i class="bi bi-plus-lg"></i> Nuevo Producto
        </button>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <input type="text" class="form-control" name="search" placeholder="Buscar por nombre o SKU" value="{{ request.args.get('search', '') }}">
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="category">
                        <option value="">Todas las categorías</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {% if request.args.get('category')|int == category.id %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Filtrar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de Productos -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="productsTable">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Nombre</th>
                            <th>Categoría</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in products %}
                        <tr>
                            <td>{{ product.sku }}</td>
                            <td>{{ product.name }}</td>
                            <td>{{ product.category.name }}</td>
                            <td>${{ "%.2f"|format(product.price) }}</td>
                            <td>
                                <span class="badge {% if product.stock < 10 %}bg-danger{% elif product.stock < 20 %}bg-warning{% else %}bg-success{% endif %}">
                                    {{ product.stock }}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="editProduct({{ product.id }})" data-bs-toggle="tooltip" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProduct({{ product.id }})" data-bs-toggle="tooltip" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Agregar/Editar Producto -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">Nuevo Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="productForm" class="needs-validation" novalidate>
                    <input type="hidden" id="productId">
                    <div class="mb-3">
                        <label class="form-label">SKU</label>
                        <input type="text" class="form-control" id="sku" required>
                        <div class="invalid-feedback">El SKU es obligatorio</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="name" required>
                        <div class="invalid-feedback">El nombre es obligatorio</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" id="description"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Categoría</label>
                        <select class="form-select" id="category_id" required>
                            <option value="">Seleccione una categoría</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">Debe seleccionar una categoría</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Precio</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="price" step="0.01" min="0" required>
                            <div class="invalid-feedback">El precio es obligatorio y debe ser mayor a 0</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Stock</label>
                        <input type="number" class="form-control" id="stock" min="0" required>
                        <div class="invalid-feedback">El stock es obligatorio y debe ser mayor o igual a 0</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Inicializar el modal
let productModal;

document.addEventListener('DOMContentLoaded', function() {
    productModal = new bootstrap.Modal(document.getElementById('productModal'));
    
    // Inicializar tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

function editProduct(id) {
    fetch(`/api/products/${id}`)
        .then(response => response.json())
        .then(product => {
            document.getElementById('productId').value = product.id;
            document.getElementById('sku').value = product.sku;
            document.getElementById('name').value = product.name;
            document.getElementById('description').value = product.description;
            document.getElementById('category_id').value = product.category.id;
            document.getElementById('price').value = product.price;
            document.getElementById('stock').value = product.stock;
            document.getElementById('productModalLabel').textContent = 'Editar Producto';
            productModal.show();
        });
}

function saveProduct() {
    const form = document.getElementById('productForm');
    if (!validateForm('productForm')) {
        return;
    }

    const id = document.getElementById('productId').value;
    const data = {
        sku: document.getElementById('sku').value,
        name: document.getElementById('name').value,
        description: document.getElementById('description').value,
        category_id: parseInt(document.getElementById('category_id').value),
        price: parseFloat(document.getElementById('price').value),
        stock: parseInt(document.getElementById('stock').value)
    };

    const method = id ? 'PUT' : 'POST';
    const url = id ? `/api/products/${id}` : '/api/products';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.ok) {
            showAlert('Producto guardado exitosamente', 'success');
            window.location.reload();
        } else {
            throw new Error('Error al guardar el producto');
        }
    })
    .catch(error => {
        showAlert(error.message, 'danger');
    });
}

function deleteProduct(id) {
    if (confirm('¿Está seguro de eliminar este producto?')) {
        fetch(`/api/products/${id}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                showAlert('Producto eliminado exitosamente', 'success');
                window.location.reload();
            } else {
                throw new Error('Error al eliminar el producto');
            }
        })
        .catch(error => {
            showAlert(error.message, 'danger');
        });
    }
}

// Limpiar formulario al abrir modal para nuevo producto
document.getElementById('productModal').addEventListener('show.bs.modal', function (event) {
    if (!event.relatedTarget) return; // Si no se abrió con el botón de nuevo producto
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    document.getElementById('productModalLabel').textContent = 'Nuevo Producto';
});
</script>
{% endblock %} 